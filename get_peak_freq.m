clear all ; close all
cd C:\shared\allres
subs = {'alex','alexandra3','audrey','charest','esteban','fabio','gab','gabriella','genevieve','gina','guillaume','jeremie','julie','katrine','leila','lisa','marc',...
    'marie','mathieu','maxime','menglu','mingham','patricia','po','russell','suhan2','sunachakan','tah','tegan2','vincent'} ; 
postgoodcs = {[8,9,25],[4,5,22,24],[14,15,21],[7,9,16],[14,15,25],[15,25,29],[8,12,21],[5,7,23,40],[3,7,8,17],[6,10,13,16],[4,35],[8,15,37],[8,12,18,26],...
    [2,6,15,22],[10,19],[4,13,20],[2,4,8],[4,6,10],[2,20,22],[2,7,11],[5,9,11],[5,9,12],[13,15,16,23],[6,8,9],[3,10,20,31,34],[6,7,12,29],[1,6,7],[10,25,31],...
    [8,14,17,21,42],[3,4,11]} ; 

badts = {...
    {[68,91,114],[29,44,92,131],[31,94,127,128],[64,128],[20,90],[21,75]},
    {[],[75],[],[56,127],[8,14,32],[111]},
    {[73,111],[100],[85],[31,116,118],[78,99],[27]},
    {[2],[2,80],[40,64,90],[54],[],[]},
    {[39],[],[7,126],[32],[73,113],[74,77]},
    {[],[11],[],[],[10],[120]},
    {[21],[],[128],[],[42,74],[42,135]},
    {[55,111],[52,75,100],[65,117],[],[47,75],[]},
    {[94],[106],[],[12,50,62,102],[],[]},
    {[47,94,112,117,128],[],[35,48,103,110,132],[26,61,135],[37,38,41],[14,22,106,111,129]},
    {[],[130],[80,117],[6,122],[],[]},
    {[88],[80,106],[],[26,59],[],[99]},
    {[34,90],[6,57,67,129],[21,57],[82,98],[35],[20]},
    {[],[],[],[44,98],[],[]},
    {[79,96],[],[],[58,94],[],[25]},
    {[58,119],[58],[18],[42],[38,57,60],[29,57]},
    {[9,13,47,100,104,122],[63,68],[15,19,44,46,47,54],[7,26,30,104],[21,62,66,69,125],[5,51,63]},
    {[41,50,54],[39,71],[66,73],[],[37],[17,20,53]},
    {[],[18,22],[10,22,110],[69],[41,103,115],[96]},
    {[11,127],[14,46,65,93],[98],[119,133],[28,57,83],[55,117]},
    {[],[],[],[],[],[11,93]},
    {[17,21,52,83],[54],[88],[38],[41],[129]},
    {[5,15,110],[50],[85,107,109],[31,77,106,107],[],[5,33]},
    {[],[84],[],[],[34],[]},
    {[],[],[],[],[],[9,41]},
    {[117,109],[1,16,23],[97],[33],[],[]},
    {[10,54,106],[3,24,106],[60],[107],[9,22,31,108],[]},
    {[79,80,89],[83],[],[17],[],[63]},
    {[56],[44,135],[76],[],[121],[]},
    {[35,44,108],[17,23,62,84],[14,98,130],[],[37],[14,27]}} ;

for sb=1:length(subs)
    cd(['c:/shared/allres/',subs{sb}]) ; 
    ls 
    fullica = load('fullica.mat') ; fullica = fullica.fullica ; 
    weights = fullica{1} ; sphere = fullica{2} ; winv = pinv(weights*sphere) ; 
    eeg = pop_loadset('cleanfilt.set') ; 
    si = load('si') ; si = si.si ;
    acts = weights*sphere*eeg.data ; acts = acts - eegfiltfft(acts,eeg.srate,84,86) ; 
    eeg.data = acts ; trigs = {'S 11','S 12','S 13','S 14','S 15','S 16'}  ;clear ersp ; triginds = [1,2,3,4,5,6] ; 
    for tr=1:6
    ep = pop_epoch(eeg,{trigs{tr}},[-.5,2.5]) ;  
    for i=1:length(postgoodcs{sb})
        [ersp(tr,i,:,:),itc,powbase,times,freqs,~,~] = newtimef(squeeze(ep.data(postgoodcs{sb}(i),:,si{triginds(tr)}(1:120))),ep.pnts,[ep.xmin,ep.xmax],ep.srate,0,...
                            'plotersp','off','plotitc','off','freqs',[1,120],'nfreqs',60,'winsize',64,'baseline',0,'verbose','off','timesout',200) ; 
    end
    end
    allersp(sb,:,:,:) = squeeze(mean(ersp,2)) ; 
    save('times','times') ; save('freqs','freqs') ; 
    amersp = squeeze(mean(ersp,2)) ; 
    save('amersp','amersp') ; 
end

